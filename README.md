# A Bowtie for a Beast (Artifact)

- [coq/](./coq) for the Coq formalization
- [spec/](./spec) for the Ott specification (that is used to generate the syntax
definition in Coq)

## Coq Formalization

### Third Party Materials

We rely on two Coq libraries:

- [`metalib`](https://github.com/plclub/metalib) for the locally nameless
representation, which needs to be downloaded and installed.

- [LibTactics.v](./coq/LibTactics.v) from [the TLC Coq library](https://www.chargueraud.org/softs/tlc/)
by Arthur Chargueraud, which is included in the artifact.

### Building Instructions

Our Coq proofs are verified in Coq **8.14.1**.

#### Prerequisites

0. `Ott` and `LNgen` are used to generate `syntax_ott.v` and `rules_inf.v`.
   You can run all code without them installed unless you want to modify the
   Ott definitions and generate the coq files.
   In this case, please install:

    - [Ott 0.31](https://github.com/ott-lang/ott/releases/tag/0.31)
    - [LNgen coq-8.10](https://github.com/plclub/lngen/releases/tag/coq-8.10)

1. Install Coq 8.14.1.
   The recommended way to install Coq is via `OPAM`. Refer to
   [here](https://coq.inria.fr/opam/www/using.html) for detailed steps. Or one could
   download the pre-built packages for Windows and MacOS via
   [here](https://github.com/coq/coq/releases/tag/V8.14.1). Choose a suitable installer
   according to your platform.

2. Install [Metalib coq8.10](https://github.com/plclub/metalib/releases/tag/coq8.10):
   1. Open the terminal
   2. `git clone https://github.com/plclub/metalib`
   3. `cd metalib/Metalib`
   4. Make sure the version is correct by `git checkout 597fd7d` (other versions may also work)
   5. `make install`

#### Build and Compile the Proofs

1. Enter [coq/](./coq) directory.

2. Type `make` in the terminal to build and compile the proofs.

3. You should see something like the following (suppose `>` is the prompt):
   ```sh
   coq_makefile -arg '-w -variable-collision,-meta-collision,-require-in-module' -f _CoqProject -o CoqSrc.mk
   COQDEP VFILES
   COQC LibTactics.v
   COQC Definitions.v
   ```
4. `Definitions.v` is generated by Ott. To reproduce it (some comments will be
lost), please remove it and run `make` (with Ott installed).

### Proof Structure

- [Definitions.v](./coq/Definitions.v) contains all definitions used in the coq
formalization. It is generated by [spec/rules.ott](spec/rules.ott).

- [LibTactics.v](./coq/LibTactics.v) is a Coq library by Arthur Chargueraud.
We downloaded it from [here](http://gallium.inria.fr/~fpottier/ssphs/LibTactics.html).

- [DistSubtyping.v](./coq/DistSubtyping.v) contains subtyping-related proofs.

- [ApplyTy.v](./coq/ApplyTy.v) proves the soundness and completeness,
monotonicity, and some inversion lemmas of the type-level dispatch relation.

- [SimpleSub.v](./coq/SimpleSub.v) is about the coverage relations.

- [Distinguishability.v](./coq./Distinguishability.v) is about the distinguishability
relation.

- [Dispatch.v](./coq/Dispatch.v) is about the disptach lemma and inversion lemmas
on type-level dispatch.
