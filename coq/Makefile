WARN_MSG = "(* !!! WARNING: AUTO GENERATED. DO NOT MODIFY !!! *)\n"

OTT_LOC    = ../spec

## Name of the submakefile generated by coq_makefile
COQMKFILENAME=CoqSrc.mk

LIBNAME="Top"

SYNTAX=syntax
TARGET=rules
OTTFILE=rules

FILES     = $(SYNTAX)_ott
VFILES   = $(foreach i, $(FILES), $(i).v)
VOFILES  = $(foreach i, $(FILES), $(i).vo)


.SECONDARY: $(VFILES)

all: coq

coq: $(COQMKFILENAME) $(VOFILES)
	@$(MAKE) -f CoqSrc.mk

%.vo: %.v $(COQMKFILENAME)
	@$(MAKE) -f $(COQMKFILENAME) $*.vo

$(SYNTAX)_ott.v: $(OTT_LOC)/$(OTTFILE).ott
	ott $(OTT_LOC)/$(OTTFILE).ott -o $(SYNTAX)_ott.v -coq_lngen true -coq_expand_list_types true
	@if grep '<<no parses (' $@ >/dev/null 2>&1 && \
	[ -z "$(DONTSTOP)" ]; then \
		echo; \
	echo "***** OTT PARSE ERROR(S) *****"; \
		grep -n '<<no parses (' $@; \
		$(RM) $@; \
		exit 1; \
	fi >&2

$(COQMKFILENAME): Makefile $(SYNTAX)_ott.v
	{ echo "-R . $(LIBNAME)" ; ls *.v ; } > _CoqProject && coq_makefile -arg '-w -variable-collision,-meta-collision,-require-in-module' -f _CoqProject -o $(COQMKFILENAME)


METALIB.FIX_%:
	sed -i -e 's/Metatheory/Metalib.Metatheory/g' $*.v
	sed -i -e 's/LibLNgen/Metalib.LibLNgen/g' $*.v
	sed '1d' $*.v > __TMP__; mv __TMP__ $*.v
	@perl -pi -e 'print $(WARN_MSG) if $$. == 1' $*.v

LCEXP.FIX_%:
	sed -i -e 's/lc_exp (v_/lc_value (v_/g' $*.v
	sed '1d' $*.v > __TMP__; mv __TMP__ $*.v
	@perl -pi -e 'print $(WARN_MSG) if $$. == 1' $*.v


coqclean:
	rm -f .*.d *.conf .*.aux *.v-e *.v.d *.vo *vio *.vos *.vok *.glob $(COQMKFILENAME)

clean: coqclean


deep_clean: clean
	@rm $(SYNTAX)_ott.v $(TARGET)_inf.v
